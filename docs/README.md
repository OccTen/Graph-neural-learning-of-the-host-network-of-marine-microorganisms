# 分类学特征推断系统

本项目实现了一个基于图神经网络的分类学特征推断系统，用于预测实体（如噬菌体、细菌）的分类学特征。系统利用现有的分类学信息和实体间的关系，构建图结构，并使用GraphSAGE模型进行特征推断。

## 系统概述

该系统主要解决的问题是：基于已知实体的分类学信息和实体间的关系，预测未知实体的分类学特征。主要应用于生物信息学领域，特别是噬菌体-宿主关系预测。

### 核心功能

1. **数据提取与处理**：从Excel文件中提取实体（噬菌体、宿主）的分类学信息
2. **特征向量化**：将分类学信息转换为数值特征向量
3. **图构建**：基于实体间关系构建异构图
4. **模型训练**：使用GraphSAGE模型学习图中节点的表示
5. **特征推断**：为未知分类学信息的实体预测其可能的分类学特征

## 技术实现

### 数据处理流程

1. **数据加载**：
   - 加载Excel格式的分类学数据
   - 提取实体ID和分类学信息（科、属、种等）
   - 处理缺失值和异常值

2. **特征编码**：
   - 使用独热编码将分类学信息转换为数值特征
   - 为每个分类学级别构建编码器
   - 生成固定维度的特征向量

3. **图构建**：
   - 创建节点表示实体
   - 根据实体间关系（如噬菌体-宿主）创建边
   - 构建异构图结构

### 模型架构

系统采用优化的GraphSAGE架构：
- 多层图卷积网络
- 残差连接提高信息传递效率
- 批归一化加速训练收敛
- 适应性学习率调整

## 开发与优化过程

### 初始开发阶段

1. **基础功能实现**：
   - 开发基本数据加载逻辑
   - 实现特征提取和编码
   - 构建简单图结构
   - 训练基础模型

2. **第一阶段问题**：
   - 特征提取不完整
   - 无法处理多种数据格式
   - 图构建效率低
   - 预测结果保存路径问题

### 优化迭代

1. **数据处理优化**：
   - 增强Excel文件格式兼容性
   - 添加自动列检测功能
   - 改进数据清洗逻辑
   - 解决编码器兼容性问题

2. **特征提取改进**：
   - 放宽特征提取条件
   - 支持处理未知分类值
   - 自动修正特征维度不一致问题
   - 添加详细日志输出

3. **图构建与模型优化**：
   - 优化图构建算法提高效率
   - 调整模型参数提高准确率
   - 使用早停机制避免过拟合
   - 增加模型评估指标

4. **结果保存与展示**：
   - 修复结果保存路径问题
   - 增加保存失败备份机制
   - 添加预测结果可视化
   - 生成详细报告

## 使用指南

### 环境配置

需要安装以下依赖：
```bash
pip install torch torch_geometric pandas numpy openpyxl matplotlib scikit-learn
```

### 运行推断

使用以下命令运行推断过程：
```bash
python inference_taxonomy.py --model_path weights/taxonomy_graphsage_optimized.pt --test_data data/test_data.xlsx --encoders data/taxonomy_values.json --output taxonomy_predictions.json --debug
```

参数说明：
- `--model_path`：预训练模型路径
- `--test_data`：测试数据文件路径
- `--encoders`：分类编码器文件路径
- `--output`：结果输出文件路径
- `--debug`：开启调试模式输出详细日志

### 训练模型

如需训练新模型，使用：
```bash
python train_taxonomy_improved.py --train_data data/training_data.xlsx --output_dir weights/ --epochs 100
```

## 结果分析

系统生成的主要输出文件：
1. `taxonomy_predictions.json`：包含所有实体的预测分类学特征
2. `detailed_predictions.json`：详细的预测结果，包含置信度和可能性分布
3. `inference_stats.json`：推断过程的统计信息
4. 可视化图表：混淆矩阵、预测类型分布、置信度分布等

## 问题排查与解决方案

### 常见问题

1. **数据格式问题**：
   - 症状：无法提取特征或特征不完整
   - 解决：检查Excel文件格式，确保列名与代码中预期一致
   - 优化：代码现已增强对多种格式的支持

2. **特征提取失败**：
   - 症状：日志显示"没有提取到特征"
   - 解决：放宽特征提取条件，增加调试信息
   - 改进：即使部分分类学信息缺失也能创建特征

3. **结果保存问题**：
   - 症状：无法找到预测结果文件
   - 解决：使用绝对路径保存，添加目录创建逻辑
   - 增强：添加备份保存机制确保结果不丢失

4. **模型预测不准确**：
   - 分析：检查训练数据质量和模型参数
   - 改进：优化模型架构，增加特征工程

## 未来工作

1. 改进特征提取以处理更多异常情况
2. 开发更高级的图构建算法
3. 尝试更多图神经网络模型变体
4. 增加基于规则的后处理以提高准确率
5. 开发Web界面方便使用

## 总结

本项目实现了一个完整的基于图神经网络的分类学特征推断系统。通过多次迭代优化，系统现在能够更稳健地处理各种数据格式，提取有效特征，并生成可靠的预测结果。系统适用于生物信息学研究，特别是噬菌体-宿主关系的分析与预测。 